const translations = {
    fi: {
        welcome: "Tervetuloa! Olen Madame Bot, miten voin auttaa tänään?",
        reservation: "Pöytävaraus",
        event: "Haluan järjestää tilaisuuden",
        giftcard: "Ostaisin lahjakortin!",
        collaboration: "Ruvetaan yhteistyöhön!",
        menu: "Haluan nähdä ruokalistan",
        feedback: "Haluan antaa palautetta",
        chat_option: "Ottakaa minuun yhteyttä",
        chat: "Kiitos! Jätä yhteystietosi niin olemme sinuun pian yhteydessä.",
        nice_to_hear: "Ihana kuulla, että haluatte tulla meille viihtymään! Montako henkeä teitä olisi tulossa?",
        person_count: {
            small: "1-8",
            medium: "9-16",
            large: "17-24",
            xl: "yli 24"
        },
        people: "hlö",
        contact_preference: "Haluatko, että otamme sinuun yhteyttä vai annatko heti lisätietoja?",
        tell_more: "Haluan, että minuun otetaan yhteyttä",
        continue_details: "Kerron mielelläni lisää heti!",
        event_type: "Kiitos! Kertoisitko tilaisuuden luonteesta? Voit valita useamman vaihtoehdon.",
        what_to_serve: "Mitä saisi olla?",
        space_question: "Haluatteko yksityistilan vai pöydän muiden joukosta?",
        private_space: "Oma tila",
        shared_space: "Pöytä muiden joukosta",
        select_date: "Valitse päivämäärä!",
        write_message: "Kirjoita viestisi tähän...",
        write_message_alert: "Kirjoita viesti ennen lähettämistä!",
        summary: "Yhteenveto:",
        event_type_label: "Tilaisuuden tyyppi:",
        offerings_label: "Tarjoilut:",
        date_label: "Ajankohta:",
        space_label: "Tila:",
        name: "Nimi *",
        email: "Sähköposti *",
        phone: "Puhelinnumero *",
        send: "Lähetä",
        fill_required: "Täytä kaikki pakolliset kentät!",
        thank_you: "Kiitos! Olemme sinuun yhteydessä pian!",
        start_new: "Aloita uusi keskustelu",
        continue: "Jatka",
        select_one: "Valitse vähintään yksi vaihtoehto!",
        event_type_options: ["Aamiainen", "Lounas", "Kokous", "Illallinen", "Juhlatilaisuus", "Yritystilaisuus", "Muu yksityistilaisuus"],
        offerings_options: ["Kahvitarjoilu", "Suolainen tai makea välitarjoilu", "Lounas", "Aamiainen", "Illallinen", "Brunssi", "Juhlatarjoilu", "Juomatarjoilu", "Muu"]
    },
    en: {
        welcome: "Welcome! I'm Madame Bot, how can I help you today?",
        reservation: "Table Reservation",
        event: "I want to organize an event",
        giftcard: "I'd like to buy a gift card!",
        collaboration: "Let's collaborate!",
        menu: "I want to see the menu",
        feedback: "I want to give feedback",
        chat_option: "Contact me",
        chat: "Thank you! Leave your contact information and we'll get back to you soon.",
        nice_to_hear: "Wonderful to hear you'd like to visit us! How many people are coming?",
        person_count: {
            small: "1-8",
            medium: "9-16",
            large: "17-24",
            xl: "more than 24"
        },
        people: "people",
        contact_preference: "Would you like us to contact you or would you like to provide more details now?",
        tell_more: "I want to be contacted",
        continue_details: "I'd like to tell more now!",
        event_type: "Thank you! Could you tell us about the nature of your event? You can select multiple options.",
        what_to_serve: "What would you like to have?",
        space_question: "Would you prefer a private space or a table in the common area?",
        private_space: "Private space",
        shared_space: "Table in common area",
        select_date: "Please select a date!",
        write_message: "Write your message here...",
        write_message_alert: "Please write a message before sending!",
        summary: "Summary:",
        event_type_label: "Event type:",
        offerings_label: "Offerings:",
        date_label: "Date:",
        space_label: "Space:",
        name: "Name *",
        email: "Email *",
        phone: "Phone *",
        send: "Send",
        fill_required: "Please fill all required fields!",
        thank_you: "Thank you! We'll be in touch soon!",
        start_new: "Start new conversation",
        continue: "Continue",
        select_one: "Please select at least one option!",
        event_type_options: ["Breakfast", "Lunch", "Meeting", "Dinner", "Celebration", "Corporate event", "Other private event"],
        offerings_options: ["Coffee service", "Savory or sweet snack", "Lunch", "Breakfast", "Dinner", "Brunch", "Celebration service", "Drink service", "Other"]
    },
    fr: {
        welcome: "Bienvenue! Je suis Madame Bot, comment puis-je vous aider aujourd'hui?",
        reservation: "Réservation de table",
        event: "Je souhaite organiser un événement",
        giftcard: "Je voudrais acheter une carte cadeau!",
        collaboration: "Collaborons ensemble!",
        menu: "Je veux voir le menu",
        feedback: "Je souhaite donner mon avis",
        chat_option: "Contactez-moi",
        chat: "Merci! Laissez vos coordonnées et nous vous contacterons bientôt.",
        nice_to_hear: "Ravi de vous accueillir! Combien de personnes serez-vous?",
        person_count: {
            small: "1-8",
            medium: "9-16",
            large: "17-24",
            xl: "plus de 24"
        },
        people: "personnes",
        contact_preference: "Souhaitez-vous que nous vous contactions ou préférez-vous donner plus de détails maintenant?",
        tell_more: "Je veux être contacté",
        continue_details: "Je préfère donner plus de détails maintenant!",
        event_type: "Merci! Pourriez-vous nous parler de la nature de votre événement? Vous pouvez sélectionner plusieurs options.",
        what_to_serve: "Que souhaiteriez-vous?",
        space_question: "Préférez-vous un espace privé ou une table dans l'espace commun?",
        private_space: "Espace privé",
        shared_space: "Table commune",
        select_date: "Veuillez sélectionner une date!",
        write_message: "Écrivez votre message ici...",
        write_message_alert: "Veuillez écrire un message avant d'envoyer!",
        summary: "Résumé:",
        event_type_label: "Type d'événement:",
        offerings_label: "Services:",
        date_label: "Date:",
        space_label: "Espace:",
        name: "Nom *",
        email: "Email *",
        phone: "Téléphone *",
        send: "Envoyer",
        fill_required: "Veuillez remplir tous les champs obligatoires!",
        thank_you: "Merci! Nous vous contacterons bientôt!",
        start_new: "Nouvelle conversation",
        continue: "Continuer",
        select_one: "Veuillez sélectionner au moins une option!",
        event_type_options: ["Petit déjeuner", "Déjeuner", "Réunion", "Dîner", "Célébration", "Événement d'entreprise", "Autre événement privé"],
        offerings_options: ["Service de café", "Snack salé ou sucré", "Déjeuner", "Petit déjeuner", "Dîner", "Brunch", "Service de célébration", "Service de boissons", "Autre"]
    }
};

document.addEventListener("DOMContentLoaded", function () {
    const chatbot = {
        toggle: document.getElementById("chat-toggle"),
        window: document.getElementById("chatbot"),
        close: document.getElementById("chat-close"),
        messages: document.getElementById("chat-messages"),
        inputs: document.getElementById("chat-inputs"),
        
        state: {
            currentStep: 'start',
            selections: {},
            userInfo: {},
            eventDetails: {
                type: [],
                offerings: [],
                date: null,
                space: null,
                persons: null
            }
        },

        currentLang: 'fi',

        init() {
            this.toggle.addEventListener("click", () => {
                this.window.classList.toggle("hidden");
                // Reset scroll position when opening chat
                if (!this.window.classList.contains("hidden")) {
                    setTimeout(() => {
                        this.messages.scrollTo({
                            top: 0,
                            behavior: 'smooth'
                        });
                    }, 100);
                }
            });
            
            this.close.addEventListener("click", () => {
                this.window.classList.add("hidden");
            });

            document.getElementById("chat-reset").addEventListener("click", () => this.resetChat());
            
            // Create messages wrapper if it doesn't exist
            if (!document.querySelector('.messages-wrapper')) {
                const wrapper = document.createElement('div');
                wrapper.className = 'messages-wrapper';
                this.messages.appendChild(wrapper);
            }

            // Add language button listeners
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', () => this.setLanguage(btn.dataset.lang));
                if (btn.dataset.lang === this.currentLang) {
                    btn.classList.add('active');
                }
            });
            
            this.startChat();
        },

        setLanguage(lang) {
            this.currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });
            this.resetChat();
        },

        getText(key) {
            return translations[this.currentLang][key] || translations['en'][key] || key;
        },

        resetChat() {
            // Reset state
            this.state = {
                currentStep: 'start',
                selections: {},
                userInfo: {},
                eventDetails: {
                    type: [],
                    offerings: [],
                    date: null,
                    space: null,
                    persons: null
                }
            };

            // Clear chat messages
            document.querySelector('.messages-wrapper').innerHTML = '';
            
            // Restart chat
            this.startChat();
        },

        async startChat() {
            this.addMessage(this.getText('welcome'), "bot");
            // Add small delay to ensure scroll position after message is added
            setTimeout(() => {
                this.messages.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }, 100);
            
            this.showOptions([
                { text: this.getText('reservation'), action: "reservation" },
                { text: this.getText('event'), action: "tarjous" },
                { text: this.getText('giftcard'), action: "lahjakortti" },
                { text: this.getText('collaboration'), action: "muu_viesti" },
                { text: this.getText('menu'), action: "menu" },
                { text: this.getText('feedback'), action: "muu_viesti" },
                { text: this.getText('chat_option'), action: "chat" }
            ]);
        },

        addMessage(text, sender) {
            const messageDiv = document.createElement("div");
            messageDiv.className = `message-in ${sender} mb-4 ${sender === 'bot' ? 'text-left' : 'text-right'}`;
            messageDiv.innerHTML = `
                <div class="chat-bubble ${sender} 
                    inline-block p-4 shadow-sm">
                    ${text}
                </div>
            `;
            document.querySelector('.messages-wrapper').appendChild(messageDiv);
            
            // Smooth scroll to new message
            setTimeout(() => {
                this.messages.scrollTo({
                    top: this.messages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        },

        showOptions(options) {
            this.inputs.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'chat-spacing';
            
            options.forEach((option, index) => {
                const button = document.createElement("button");
                // Update classes here
                button.className = "w-full p-3 bg-white/80 text-luxury-dark rounded-xl hover:bg-luxury-navy hover:text-luxury-light transition-all duration-300 transform hover:-translate-y-1 shadow-sm";
                button.style.animationDelay = `${index * 100}ms`;
                button.textContent = option.text;
                button.onclick = () => this.handleAction(option.action);
                container.appendChild(button);
            });
            
            this.inputs.appendChild(container);
        },

        handleAction(action) {
            if (action && action !== 'talk') {
                this.addMessage(`${this.getActionText(action)}`, 'user');  // Removed "Valitsit: "
            }

            const actionMap = {
                'reservation': () => this.handleReservation(),
                'tarjous': () => this.handleTarjous(),
                'lahjakortti': () => window.open('https://madame.fi/lahjakortit', '_blank'),
                'menu': () => window.open('https://madame.fi/menu', '_blank'),
                'muu_viesti': () => this.showMuuViesti(),
                'small_group': () => window.open('https://varaukset.madame.fi', '_blank'),
                'medium_group': () => this.startTilaisuudenSuunnittelu(),
                'large_group': () => this.startTilaisuudenSuunnittelu(),
                'xl_group': () => this.startTilaisuudenSuunnittelu(),
                'private_space': () => this.showDatePicker('private'),
                'shared_space': () => this.showDatePicker('shared'),
                'chat': () => this.handleChat()
            };

            if (actionMap[action]) actionMap[action]();
        },

        getActionText(action) {
            const actionTexts = {
                'reservation': this.getText('reservation'),
                'tarjous': this.getText('event'),
                'lahjakortti': this.getText('giftcard'),
                'menu': this.getText('menu'),
                'muu_viesti': this.getText('feedback'),
                'small_group': "1-8",
                'medium_group': "9-16",
                'large_group': "17-24",
                'xl_group': "24+",
                'private_space': this.getText('private_space'),
                'shared_space': this.getText('shared_space'),
                'talk': this.getText('chat')
            };
            return actionTexts[action] || action;
        },

        handleReservation() {
            this.addMessage(this.getText('nice_to_hear'), "bot");
            this.showOptions([
                { text: "1-8", action: "small_group" },
                { text: "9-16", action: "medium_group" },
                { text: "17-24", action: "large_group" },
                { text: "24+", action: "xl_group" }
            ]);
        },

        handleTarjous() {
            this.addMessage(this.getText('contact_preference'), "bot");
            this.showOptions([
                { text: this.getText('tell_more'), action: "chat" },
                { text: this.getText('continue_details'), action: "reservation" }
            ]);
        },

        startTilaisuudenSuunnittelu() {
            this.addMessage(this.getText('event_type'), "bot");
            const options = this.getText('event_type_options');
            this.showMultipleChoice(options, this.handleEventTypeSelected.bind(this));
        },

        showMultipleChoice(options, callback) {
            this.inputs.innerHTML = '';
            options.forEach(option => {
                const div = document.createElement('div');
                div.className = 'flex items-center mb-3 p-2 hover:bg-old-money-200/30 rounded-lg transition-all';
                div.innerHTML = `
                    <input type="checkbox" id="${option}" class="custom-checkbox mr-3">
                    <label for="${option}" class="cursor-pointer flex-grow">${option}</label>
                `;
                this.inputs.appendChild(div);
            });
            
            const confirmButton = document.createElement('button');
            confirmButton.textContent = this.getText('continue');
            confirmButton.className = 'w-full p-3 btn-old-money rounded-xl mt-4 animate-fade-in';
            confirmButton.onclick = callback;
            this.inputs.appendChild(confirmButton);

            const stepName = callback.name.includes('EventType') ? 'eventTypeMultipleChoice' : 'offeringsMultipleChoice';
            this.state.currentStep = stepName;
        },

        handleEventTypeSelected() {
            const selections = Array.from(this.inputs.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.id);
            
            if (selections.length === 0) {
                alert(this.getText('select_one'));
                return;
            }

            this.state.eventDetails.type = selections;
            this.addMessage(`${selections.join(', ')}`, 'user');  // Removed "Valitsit: "
            this.showOfferingsSelection();
        },

        showOfferingsSelection() {
            this.addMessage(this.getText('what_to_serve'), "bot");
            const options = this.getText('offerings_options');
            this.showMultipleChoice(options, this.handleOfferingsSelected.bind(this));
        },

        handleOfferingsSelected() {
            const selections = Array.from(this.inputs.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.id);
            
            if (selections.length === 0) {
                alert(this.getText('select_one'));
                return;
            }

            this.state.eventDetails.offerings = selections;
            this.addMessage(`${selections.join(', ')}`, 'user');  // Removed "Valitsit: "
            this.showSpaceSelection();
        },

        showSpaceSelection() {
            this.addMessage(this.getText('space_question'), "bot");
            this.showOptions([
                { text: this.getText('private_space'), action: "private_space" },
                { text: this.getText('shared_space'), action: "shared_space" }
            ]);
        },

        handleLargeGroup() {
            this.state.currentStep = 'large_group';
            this.showEventTypeSelection();
        },

        showDatePicker(spaceType) {
            this.state.eventDetails.space = spaceType;
            this.inputs.innerHTML = `
                <input type="datetime-local" id="eventDate" class="w-full mb-2 p-2 border rounded">
                <button id="dateButton" class="w-full p-2 bg-blue-500 text-white rounded">${this.getText('continue')}</button>
            `;
            document.getElementById("dateButton").addEventListener("click", () => this.handleDateSelection());
        },

        handleDateSelection() {
            const dateInput = document.getElementById("eventDate");
            if (!dateInput.value) {
                alert(this.getText('select_date'));
                return;
            }
            this.state.eventDetails.date = dateInput.value;
            this.showTalkForm();
        },

        showMuuViesti() {
            this.inputs.innerHTML = `
                <textarea id="freeMessage" placeholder="${this.getText('write_message')}" 
                    class="w-full mb-2 p-2 border rounded h-24"></textarea>
                <button id="messageButton" 
                    class="w-full p-2 bg-blue-500 text-white rounded">${this.getText('send')}</button>
            `;
            document.getElementById("messageButton").addEventListener("click", () => this.handleMuuViesti());
        },

        handleMuuViesti() {
            const message = document.getElementById("freeMessage").value;
            if (!message) {
                alert(this.getText('write_message_alert'));
                return;
            }
            this.state.selections.message = message;
            this.showTalkForm();
        },

        showTalkForm() {
            let summary = '';
            if (Object.keys(this.state.eventDetails).length > 0) {
                const details = this.state.eventDetails;
                summary = `
                    <div class="mb-4 p-2 bg-gray-100 rounded">
                        <h3 class="font-bold">${this.getText('summary')}</h3>
                        ${details.type?.length ? `<p>${this.getText('event_type_label')} ${details.type.join(', ')}</p>` : ''}
                        ${details.offerings?.length ? `<p>${this.getText('offerings_label')} ${details.offerings.join(', ')}</p>` : ''}
                        ${details.date ? `<p>${this.getText('date_label')} ${new Date(details.date).toLocaleString('fi-FI')}</p>` : ''}
                        ${details.space ? `<p>${this.getText('space_label')} ${details.space === 'private' ? this.getText('private_space') : this.getText('shared_space')}</p>` : ''}
                    </div>
                `;
            }

            this.inputs.innerHTML = summary + `
                <input type="text" id="name" placeholder="${this.getText('name')}" required class="w-full mb-2 p-2 border rounded">
                <input type="email" id="email" placeholder="${this.getText('email')}" required class="w-full mb-2 p-2 border rounded">
                <input type="tel" id="phone" placeholder="${this.getText('phone')}" required class="w-full mb-2 p-2 border rounded">
                <button id="sendForm" class="w-full p-2 bg-blue-500 text-white rounded">${this.getText('send')}</button>
            `;

            document.getElementById("sendForm").onclick = () => this.submitForm();
        },

        submitForm() {
            const name = document.getElementById("name").value;
            const email = document.getElementById("email").value;
            const phone = document.getElementById("phone").value;

            if (!name || !email || !phone) {
                alert(this.getText('fill_required'));
                return;
            }

            // Prepare form data
            const formData = new FormData();
            formData.append('name', name);
            formData.append('email', email);
            formData.append('phone', phone);

            // Add event details if they exist
            if (Object.keys(this.state.eventDetails).length > 0) {
                const details = this.state.eventDetails;
                if (details.type?.length) formData.append('event_type', details.type.join(', '));
                if (details.offerings?.length) formData.append('offerings', details.offerings.join(', '));
                if (details.date) formData.append('date', new Date(details.date).toLocaleString('fi-FI'));
                if (details.space) formData.append('space', details.space === 'private' ? this.getText('private_space') : this.getText('shared_space'));
            }

            // Add free message if it exists
            if (this.state.selections.message) {
                formData.append('message', this.state.selections.message);
            }

            // Send form data to Formspree
            fetch('https://formspree.io/f/myzkpybg', {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json'
                }
            }).then(response => {
                if (response.ok) {
                    this.addMessage(this.getText('thank_you'), "bot");
                    this.inputs.innerHTML = `
                        <button id="resetChat" class="w-full p-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                            ${this.getText('start_new')}
                        </button>
                    `;
                    document.getElementById("resetChat").addEventListener("click", () => this.resetChat());
                } else {
                    alert('There was an error sending your message. Please try again later.');
                }
            }).catch(error => {
                alert('There was an error sending your message. Please try again later.');
            });
        },

        handleChat() {
            this.addMessage(this.getText('chat'), "bot");
            this.showTalkForm();
        }
    };

    chatbot.init();
});
